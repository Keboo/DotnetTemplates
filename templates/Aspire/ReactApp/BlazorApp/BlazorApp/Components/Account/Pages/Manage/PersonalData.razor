@page "/Account/Manage/PersonalData"

@using Microsoft.AspNetCore.Identity
@using BlazorApp.Data

@inject UserManager<ApplicationUser> UserManager
@inject IdentityRedirectManager RedirectManager

<PageTitle>Personal Data</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Personal Data</MudText>
<StatusMessage />

<MudPaper Elevation="2" Class="pa-4" Style="max-width: 600px;">
    <MudText Typo="Typo.body1" Class="mb-3">
        Your account contains personal data that you have given us. This page allows you to download or delete that data.
    </MudText>
    <MudAlert Severity="Severity.Warning" Class="mb-4">
        <strong>Deleting this data will permanently remove your account, and this cannot be recovered.</strong>
    </MudAlert>
    
    <MudStack Spacing="3">
        <form action="Account/Manage/DownloadPersonalData" method="post">
            <AntiforgeryToken />
            <MudButton Variant="Variant.Filled" 
                       Color="Color.Primary" 
                       Size="Size.Large"
                       StartIcon="@Icons.Material.Filled.Download"
                       ButtonType="ButtonType.Submit">Download My Data</MudButton>
        </form>
        
        <MudButton Variant="Variant.Filled" 
                   Color="Color.Error" 
                   Size="Size.Large"
                   StartIcon="@Icons.Material.Filled.DeleteForever"
                   Href="Account/Manage/DeletePersonalData">Delete My Account</MudButton>
    </MudStack>
</MudPaper>

@code {
    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        var user  = await UserManager.GetUserAsync(HttpContext.User);
        if (user is null)
        {
            RedirectManager.RedirectToInvalidUser(UserManager, HttpContext);
        }
    }
}
